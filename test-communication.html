<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tauri通讯功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .log {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tauri通讯功能测试</h1>
        
        <div class="test-section" id="environmentTest">
            <h3>环境检测</h3>
            <p id="environmentStatus">检测中...</p>
            <button class="btn-primary" onclick="testEnvironment()">重新检测环境</button>
        </div>
        
        <div class="test-section" id="tauriApiTest">
            <h3>Tauri API测试</h3>
            <p id="tauriApiStatus">准备测试...</p>
            <button class="btn-primary" onclick="testTauriApi()">测试Tauri API</button>
        </div>
        
        <div class="test-section" id="rustCommunicationTest">
            <h3>Rust后端通讯测试</h3>
            <p id="rustCommunicationStatus">准备测试...</p>
            <button class="btn-success" onclick="testRustCommunication()">测试Rust通讯</button>
            <button class="btn-primary" onclick="getSystemInfo()">获取系统信息</button>
        </div>
        
        <div class="test-section">
            <h3>测试日志</h3>
            <div class="log" id="testLog"></div>
            <button class="btn-danger" onclick="clearLog()">清空日志</button>
        </div>
    </div>

    <script>
        let logElement = document.getElementById('testLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            
            if (type === 'error') {
                logEntry.style.color = '#dc3545';
            } else if (type === 'success') {
                logEntry.style.color = '#28a745';
            }
            
            logElement.appendChild(logEntry);
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function clearLog() {
            logElement.innerHTML = '';
            log('日志已清空');
        }
        
        function detectTauriEnvironment() {
            return typeof window.__TAURI__ !== 'undefined';
        }
        
        function testEnvironment() {
            const envSection = document.getElementById('environmentTest');
            const statusElement = document.getElementById('environmentStatus');
            
            const isTauri = detectTauriEnvironment();
            
            if (isTauri) {
                envSection.className = 'test-section success';
                statusElement.innerHTML = '✅ Tauri环境检测成功！';
                log('Tauri环境检测: 是', 'success');
                log('window.__TAURI__对象存在', 'success');
                
                // 检查具体的API
                if (window.__TAURI__.invoke) {
                    log('window.__TAURI__.invoke API存在', 'success');
                } else {
                    log('window.__TAURI__.invoke API不存在', 'error');
                }
                
                if (window.__TAURI__.window) {
                    log('window.__TAURI__.window API存在', 'success');
                } else {
                    log('window.__TAURI__.window API不存在', 'error');
                }
                
            } else {
                envSection.className = 'test-section error';
                statusElement.innerHTML = '❌ 未检测到Tauri环境（在浏览器中运行）';
                log('Tauri环境检测: 否', 'error');
                log('window.__TAURI__对象不存在', 'error');
            }
        }
        
        function testTauriApi() {
            const apiSection = document.getElementById('tauriApiTest');
            const statusElement = document.getElementById('tauriApiStatus');
            
            if (!detectTauriEnvironment()) {
                statusElement.innerHTML = '❌ 无法测试API（不在Tauri环境中）';
                log('无法测试Tauri API：不在Tauri环境中', 'error');
                return;
            }
            
            log('开始测试Tauri API...');
            
            // 测试invoke API
            try {
                if (window.__TAURI__.invoke) {
                    log('✅ window.__TAURI__.invoke API测试通过', 'success');
                } else {
                    log('❌ window.__TAURI__.invoke API测试失败', 'error');
                }
            } catch (error) {
                log(`❌ invoke API测试失败: ${error.message}`, 'error');
            }
            
            // 测试window API
            try {
                if (window.__TAURI__.window) {
                    log('✅ window.__TAURI__.window API测试通过', 'success');
                    
                    // 测试获取当前窗口
                    const currentWindow = window.__TAURI__.window.getCurrent();
                    if (currentWindow) {
                        log('✅ 获取当前窗口成功', 'success');
                    }
                } else {
                    log('❌ window.__TAURI__.window API测试失败', 'error');
                }
            } catch (error) {
                log(`❌ window API测试失败: ${error.message}`, 'error');
            }
            
            apiSection.className = 'test-section success';
            statusElement.innerHTML = '✅ Tauri API测试完成';
        }
        
        async function testRustCommunication() {
            const commSection = document.getElementById('rustCommunicationTest');
            const statusElement = document.getElementById('rustCommunicationStatus');
            
            if (!detectTauriEnvironment()) {
                statusElement.innerHTML = '❌ 无法测试通讯（不在Tauri环境中）';
                log('无法测试Rust通讯：不在Tauri环境中', 'error');
                return;
            }
            
            log('开始测试Rust后端通讯...');
            
            try {
                // 测试调用Rust后端函数
                const result = await window.__TAURI__.invoke('get_system_info');
                
                log('✅ Rust后端通讯测试成功！', 'success');
                log(`收到系统信息: CPU=${result.cpu_name}, 内存=${result.memory_total}字节`, 'success');
                
                commSection.className = 'test-section success';
                statusElement.innerHTML = '✅ Rust后端通讯正常';
                
            } catch (error) {
                log(`❌ Rust后端通讯测试失败: ${error.message}`, 'error');
                
                commSection.className = 'test-section error';
                statusElement.innerHTML = '❌ Rust后端通讯失败';
            }
        }
        
        async function getSystemInfo() {
            if (!detectTauriEnvironment()) {
                log('❌ 无法获取系统信息（不在Tauri环境中）', 'error');
                return;
            }
            
            log('正在获取系统信息...');
            
            try {
                const startTime = Date.now();
                const systemInfo = await window.__TAURI__.invoke('get_system_info');
                const endTime = Date.now();
                
                log(`✅ 获取系统信息成功（耗时: ${endTime - startTime}ms）`, 'success');
                log(`CPU信息: ${systemInfo.cpu_name} (${systemInfo.cpu_cores}核心, ${systemInfo.cpu_usage.toFixed(1)}%使用率)`);
                log(`内存信息: ${(systemInfo.memory_used / 1024 / 1024 / 1024).toFixed(2)}GB / ${(systemInfo.memory_total / 1024 / 1024 / 1024).toFixed(2)}GB (${systemInfo.memory_usage.toFixed(1)}%使用率)`);
                log(`GPU信息: ${systemInfo.gpu_name} (${systemInfo.gpu_usage.toFixed(1)}%使用率)`);
                log(`操作系统: ${systemInfo.os_name} ${systemInfo.os_version}`);
                
            } catch (error) {
                log(`❌ 获取系统信息失败: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动运行环境检测
        window.addEventListener('load', function() {
            log('测试页面已加载');
            testEnvironment();
        });
    </script>
</body>
</html>